<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Rust CLI mit Docker ausliefern &mdash; KevOps</title><meta name=author content="Kevin Gimbel"><meta name=description content="Personal website of Kevin Gimbel, DevOps Engineer, about photography, books, coding, devops, gaming, and whatever comes in between"><meta keywords="rust docker cli  blog code"><link rel=icon href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5u4PC90ZXh0Pjwvc3ZnPg=="><style type=text/css>*{margin:0;padding:0;box-sizing:inherit}:root{--color-main: #403D58;--color-secondary: #dea584}html,body{box-sizing:border-box;font:18px/1.65 sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}abbr{cursor:help;text-decoration:none;border-bottom:2px dotted var(--color-main)}a{color:var(--color-main);font-weight:700}.footer a,.author a,.intro-text a{color:var(--color-secondary);font-weight:700}.fg-accent{color:var(--color-secondary)}.x-small{font-size:.85rem}.xx-small{font-size:.65rem}h1{font-size:2em}.article-content h2,.article-content h3{margin-top:2rem}.section-headline{font-size:2.75em;margin-top:2rem}.section-headline,h1,h2{display:inline-block;position:relative;z-index:2;color:var(--color-main)}.section-headline::after,h1::after,h2::after{content:"";width:100%;display:block;height:.35em;background:var(--color-secondary);opacity:.75;bottom:.3em;position:absolute;left:0;z-index:-1}.intro-text{padding:2rem;background:#222;color:#fff;font-size:140%}.main,.footer{max-width:85rem;width:100%;margin:0 auto;padding:2rem}hr{border:none;background:var(--color-main);height:2px}.footer{background:#222;color:#fff}.main{border-bottom:0;min-height:100vh;padding:2rem 2rem 0}.main p{margin-top:1rem;margin-bottom:1.5rem}.exif{padding:.5rem;background:var(--color-secondary)}.exif li{display:inline-block;background:#333;color:#ccc;border-radius:3px;padding:.125rem .5rem;font-size:.8rem}.exif .label{font-size:.75rem}@media all and (max-width:800px){.exif li{margin-top:.5rem}.gallery img{max-width:100%;max-width:calc(100% + 2rem)}}figure img,figure picture{margin:0 auto;display:block;height:auto;width:auto;margin:0 auto;max-width:calc(101% - 3px)}.art figure img,.art figure picture,.photography figure img,.photography figure picture{width:auto;max-width:calc(100% + 2rem + 1px)}figcaption p{display:block;line-height:1.65;background:var(--color-secondary);color:#fff;margin-top:0;padding:.5rem;text-align:right;font-size:var(--font-small,.85rem)}figure{position:relative;z-index:1;margin-left:calc(0rem - 2rem)}figure+figure{margin-top:2rem}figcaption{display:flex;justify-content:flex-end}figcaption p{margin:0!important;background:var(--color-secondary);color:var(--color-main);font-size:.85em}@media all and (min-width:800px){figure{width:auto;max-width:calc(100% + 4rem + 2px);margin-left:calc(0rem - 2rem - 1px)}figcaption p{width:50%}.gallery{display:flex;flex-wrap:wrap;justify-content:flex-start}figure.gallery__figure{margin:0;padding:.25rem}.gallery__figure img,.gallery__figure picture{display:block;height:auto;width:100%;margin:0 auto}figure.gallery__figure--w-100{width:100%}figure.gallery__figure--w-50{width:50%}figure.gallery__figure--w-33{width:33%}figure.gallery__figure--w-25{width:25%}}p code,li code{background:var(--color-secondary);color:var(--color-main);padding:.125rem .25rem;border-radius:3px}.highlight{margin-left:calc(0rem - 2rem);width:calc(100% + 4rem)}.nav-main{list-style:none;width:100%;background:#222}.nav-main li{display:inline-block;padding:.25rem 1rem;background:var(--color-main)}.nav-main li a{color:#fff;text-decoration:none}.page-nav{width:calc(100% + 4rem);background:var(--color-secondary);margin:2rem calc(0rem - 2rem);padding:2rem}.page-nav a:not(:last-of-type){margin-right:.5rem}.subscribe-via{width:calc(100% + 4rem);background:var(--color-main);color:#fff;margin-left:calc(0rem - 2rem);margin-top:-2rem;padding:.5rem 2rem}.subscribe-via a{color:#fff}.page-nav--label{display:block;font-size:.75em}.article-content{padding-bottom:2rem}.article-single{width:100%;max-width:60rem;margin:0 auto}.article-header{font-size:90%}.article-content ol,.article-content ul{margin-left:2rem}.article-list__header{margin-bottom:2rem}.article.article--in-list{padding:2rem;position:relative;background:var(--color-secondary);border-left:1px solid var(--color-secondary);z-index:1;margin-bottom:6rem}.article.article--in-list figcaption,.article.article--in-list figcaption p{color:var(--color-secondary);background:var(--color-main)}.article.article--in-list:before{content:"";display:block;position:absolute;width:100%;height:100%;left:-1.5rem;top:-1.5rem;z-index:-1;border:2px solid var(--color-main)}.article-preview__heading{font-size:1.75rem}.article-preview__publish-date a{opacity:.75;text-decoration:none}pre{padding:1rem;overflow:auto}.tag-list__item{display:inline-block;background:var(--color-main);color:var(--color-secondary);border-radius:3px;padding:.125rem .25rem;margin-bottom:.5rem;margin-right:.5rem}.tag-list__item a{color:var(--color-secondary)}@media all and (min-width:800px){.footer,.author,.support{display:flex;justify-content:space-between}.author .left,.support .left,.footer .left{margin-bottom:0}}.author .left,.support .left,.footer .left{margin-bottom:2rem}.author,.support{background:var(--color-main);color:#fff;padding:4rem 2rem;width:calc(100% + 4rem);margin-left:calc(0rem - 2rem)}.support+.author{margin-top:0}.support{background:var(--color-secondary);color:var(--color-main);flex-direction:column}.support a{color:var(--color-main)}.author p,.support p{margin-bottom:0}@media all and (min-width:800px){.author .right{padding-left:2rem}.author .avatar{margin-left:2rem}}.author .avatar{max-width:200px;transition:all linear 60s}.author .avatar:hover{animation:avatar-hue linear 15s infinite}@keyframes avatar-hue{from{filter:hue-rotate(0deg)}to{filter:hue-rotate(360deg)}}.age-note{background:#d46767;border:.35rem solid #b22222;padding:1rem 2rem;width:calc(100% + 4rem + 2px);margin-left:-2rem;margin-top:-2rem;color:#222}.tags-categories,.license{background:#d3d3d3;width:calc(100% + 4rem + 2px);margin-left:calc(0rem - 2rem - 1px);padding:2rem}.side-by-side img{width:auto;max-width:100%}@media all and (min-width:640px){.tags-categories{display:flex}.tags-categories .tags{margin-left:2rem}.side-by-side{display:flex;flex-direction:row;align-items:center;margin:2rem 0}.side-by-side.align-top{align-items:flex-start}.side-by-side.align-bottom{align-items:flex-end}.side-by-side__first{margin-bottom:3rem}.side-by-side__off-left{margin-left:-20vw}.side-by-side .small{max-width:40%;padding:2rem}.side-by-side .bg{background:var(--color-main);color:var(--color-secondary)}.side-by-side .wide{max-width:60%}.side-by-side img,.side-by-side figure{max-width:100%;margin:0}}.note{background:var(--color-main);color:#fff;padding:1rem 1rem 1rem 2rem;border-left:.5rem solid var(--color-secondary);margin:2rem 1rem;width:calc(100% - 1rem)}.note__heading{font-weight:700;display:block}.taxonomy-list{display:flex;padding-bottom:2rem;align-content:flex-end;justify-content:space-between;flex-wrap:wrap}.taxonomy__item{width:20%;height:2rem;display:inline-block;padding:2rem 0}.taxonomy__item-inner{padding:1rem;background:var(--color-main);color:var(--color-secondary)}.taxonomy__item a{color:var(--color-secondary)}.article-note__content{font-size:1.3rem}.language-nav{font-size:.75rem}.language-nav ul{display:inline-block;list-style:none}blockquote{font-size:110%;font-style:italic;text-indent:1rem;border-left:.25rem solid var(--color-main);padding:.25rem 0;padding-left:1rem}.series__box:before{content:"";display:block;position:absolute;width:100%;height:100%;left:-1rem;top:-1rem;z-index:-1;border:2px solid var(--color-main)}.series__box{float:left;padding:2rem;margin:2rem;position:relative;background:var(--color-secondary);z-index:1;display:block;margin-left:-5vw}.tag-list__item{display:inline-block;background:var(--color-secondary);color:var(--color-main);padding:.125rem .25rem;border-radius:0;margin-bottom:.5rem;margin-right:.5rem;position:relative;padding:.25em .5em;z-index:1}.tag-list__item:before{content:"";width:100%;height:100%;border:2px solid var(--color-main);left:-.45em;top:-.45em;display:block;position:absolute;z-index:-1;transition:all linear .1s}.tag-list__item:hover::before{top:-.1rem;left:-.1rem}.tag-list__item a{color:var(--color-main);text-decoration:none}ul.tag-list,ul.category-list{margin-top:1rem}table{background:#fff;border-spacing:unset;border-right:1px solid;border-left:1px solid;width:calc(100% + 30rem);margin-left:-15rem}thead{background:var(--color-main);color:var(--color-secondary)}thead th{text-align:left;padding-left:.5rem}tbody td{padding:.5rem;border-bottom:1px solid #333}.intro-text{display:none}body.section-tags .intro-text,body.section-categories .intro-text{display:block}.rating-list{font-size:2rem}.support-cause-list{text-indent:1rem;margin-bottom:1rem}.support-cause-list li{margin-left:1rem}.support-cause-list .head{margin-left:-1rem;font-size:1.25em;list-style:none}</style></head><body class="type-page section-blog"><script type=text/javascript>(function(window,document,undefined){let theme=window.localStorage.getItem("kgde_theme");if(theme){var[colorMain,colorSecondary]=JSON.parse(theme).colors;document.body.style=`--color-main:${colorMain};--color-secondary:${colorSecondary}`;}else{let themes=[["#123D3C","#90F072"],["#403D58","#dea584"],["#400E3B","#DCC78A"],["#17098D","#EADD1C"],["#233B07","#FFDD6D"],["#37059F","#D1D99F"]]
var[colorMain,colorSecondary]=themes[Math.floor(Math.random()*themes.length)];document.body.style=`--color-main:${colorMain};--color-secondary:${colorSecondary}`;}
document.addEventListener('DOMContentLoaded',function(){let schema_btn=document.querySelector("#btn_schema");let theme=window.localStorage.getItem("kgde_theme");let text_keep=document.querySelector("#widget_color_changer_txt_keep").textContent;let text_random=document.querySelector("#widget_color_changer_txt_random").textContent;if(theme){schema_btn.textContent=text_random;}else{schema_btn.textContent=text_keep;}
schema_btn.style.display="block";schema_btn.addEventListener('click',function(e){if(theme){window.localStorage.removeItem("kgde_theme");window.location=window.location;}else{window.localStorage.setItem("kgde_theme",JSON.stringify({colors:[colorMain,colorSecondary]}));window.location=window.location;}});});}(window,document));</script><span style=display:none aria-hidden=true id=widget_color_changer_txt_keep>Aktuelles Farbschema beibehalten</span>
<span style=display:none aria-hidden=true id=widget_color_changer_txt_random>Zufälliges Farbschema verwenden</span>
<button id=btn_schema style=position:absolute;top:10px;right:10px;display:none></button><header class=intro-text><span>Rust CLI mit Docker ausliefern</span></header><nav role=navigation id=navigation aria-label="Main Navigation"><ul class=nav-main><li><a href=/de/><span>Start</span></a></li><li><a href=/de/ueber-mich/><span>Über mich</span></a></li><li><a href=/de/blog><span>Blog</span></a></li></ul></nav><main id=main class=main><section class=article-single><article class=article-content><header class=article-header><h1>Rust CLI mit Docker ausliefern</h1><p>6.08.2020 |
6.08.12020 <abbr title="Holozän-Kalender, auch Human Era (Menschliche Ära), ist ein angepasster Kalender, der 10.000 Jahre vor dem christlichen Kalender mit einbezieht. Die Zeitrechnung beginnt mit dem Übergang der Menschen von Jägern und Sammlern zu Wohnhaften Bauern und dem erbauen erster Städte.">HE</abbr></p></header><div class=content><p>Vor kurzem habe ich einen Weg gefunden Rust <abbr title="Command Line Interfaces; Programme die in einem Terminal ausgeführt werden">CLI</abbr>
Programme über Docker auszuliefern. Für meinen Arbeitgeber <a href=https://synoa.de>Synoa</a> habe ich in den letzten Monaten ein CLI Tool erstellt, dass mir - und anderen - die Arbeit mit AWS erleichtert. Diese CLI im Team zu verteilen gestaltete sich als schwierig da weder jeder Rust installiert hat noch eine einfache Integration mit <a href=https://brew.sh>Homebrew</a> möglich war da der Code in einem privaten Repository ist. Die einfachste Lösung war am Ende, die CLI in einen Docker Container zu packen und so zu verteilen. Wie das geht erkläre ich in diesem Artikel.</p><h2 id=rust-code>Rust Code</h2><p>Der folgende Beispiel Code zeigt ein kleines Rust Programm, dass die Argumente ausgibt die während der Ausführung übergeben wurden.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> std::env;

<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>let</span> args: Vec<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> env::args().collect();
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{:?}&#34;</span>, args);
}
</code></pre></div><p>Der Code muss nicht verstanden werden um die Konzepte aus diesem Artikel zu verstehen! Das Muster ist für alle Binary-Programme gleich, z.B. könnte genauso eine Go App über Docker verteilt werden.</p><h2 id=code-kompilieren---in-docker>Code kompilieren - in Docker</h2><p>Den oben gezeigten Code können wir nun kompilieren, dass heißt ihn zu einer ausführbaren Binär-Datei &ldquo;zusammenfügen&rdquo;. Hierfür verwenden wir einen <a href=https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds>&ldquo;Multi-Stage&rdquo; Build</a> in Docker. So müssen wir und andere Entwickler keine vollständige Rust Umgebung verwalten und außerdem kann jeder Entwickler über Docker in der selben Umgebung Binaries kompilieren.</p><p>Zunächst deklarieren wir einen <code>builder</code> Container. Dieser Container wird genutzt um unseren Rust Code zu kompilieren.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> clux/muslrust:1.45.0-stable as builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /volume</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cargo build --release<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Diese vier Zeilen tun folgendes:</p><ul><li>Erstelle einen Container auf Basis von <a href=https://github.com/clux/muslrust><code>clux/muslrust</code></a></li><li>Dem Container wird der &ldquo;Name&rdquo; <code>builder</code> gegeben</li><li>Das Arbeitsverzeichnis wird auf <code>/volume</code> gesetzt, damit wird Docker alle Befehle in diesem Verzeichnis ausführen</li><li>Alle Dateien werden aus dem aktuellen Verzeichnis in den Container kopiert</li><li>Das Kommando <code>cargo build --release</code> wird <em>im Container</em> ausgeführt und kompiliert unseren Code</li></ul><h2 id=das-eigentliche-docker-image-erzeugen>Das eigentliche Docker Image erzeugen</h2><p>Nun können wir im selben Dockerfile unser eigentliches Image erzeugen. Dafür wird das kompilierte Binary aus dem <code>builder</code> container kopiert.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Kopiere das kompilierte Binary aus dem builder container</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /volume/target/x86_64-unknown-linux-musl/release/docker-cli-sample .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Alle CLI argumente werden direkt an das Binary übergeben</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Was geschieht hier?</p><ul><li>Zuerst erstellen wir einen neuen Docker Container auf basis des <a href=https://alpinelinux.org/>Alpine Linux</a> Images.</li><li>Dann kopieren wir das kompilierte Binary <em>aus dem builder Container</em> in unseren neuen Container</li><li>Zuletzt sagen wir, dass das Binary als &ldquo;Startpunkt&rdquo; verwendet werden soll. Soll heißen wenn der Container gestartet wird, dann wird dieses Binary ausgeführt</li></ul><p>Warum Alpine Linux? Alpine Linux ist eine kleine auf Sicherheit fokusierte Linux Distribution. Das Alpine Docker image ist nur ca. 3MB groß - kleiner geht kaum!</p><p>Alles zusammen sieht unser Dockerfile nun wie folgt aus:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> clux/muslrust:1.45.0-stable as builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /volume</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cargo build --release<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /volume/target/x86_64-unknown-linux-musl/release/docker-cli-sample .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><h2 id=image-bauen-und-den-container-ausführen>Image bauen und den Container ausführen</h2><p>Mit dem oben gezeigten Dockerfile können wir nun ein Image bauen. Hierfür benutzen wir folgenden Befehl:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t kevingimbel/rust-docker-cli-sample:1.0 .  
</code></pre></div><p>Anschließend können wir einen Container ausführen, der das neu erstellte Image benutzt:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker run --rm kevingimbel/rust-docker-cli-sample:1.0 -hello -world
<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span>, <span style=color:#e6db74>&#34;-hello&#34;</span>, <span style=color:#e6db74>&#34;-world&#34;</span><span style=color:#f92672>]</span>
</code></pre></div><h2 id=terminal-konfiguration>Terminal konfiguration</h2><p>Damit wir diesen Docker Container wie ein &ldquo;normales&rdquo; binary ausführen können müssen wir im Terminal ein &ldquo;alias&rdquo; setzen. Hierfür kommt folgende in die <code>~/.bashrc</code> bzw. <code>~/.zshrc</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>alias docker-rust-cli<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;docker run --rm kevingimbel/rust-docker-cli-sample:1.0&#39;</span>
</code></pre></div><p>Nun laden wir die Konfigurationsdatei neu oder öffnen ein neues Terminal Fenster und dann kann der Container wie ein normales Script ausgeführt werden.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># bash</span>
source ~/.bashrc
<span style=color:#75715e># zsh</span>
source ~/.zshrc
</code></pre></div><p>Danach können wir den Container mit dem Befehl <code>docker-rust-cli</code> starten.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker-rust-cli hello from docker
<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#e6db74>&#34;from&#34;</span>, <span style=color:#e6db74>&#34;docker&#34;</span><span style=color:#f92672>]</span>
</code></pre></div><h2 id=fortgeschritten-volumes>Fortgeschritten: Volumes</h2><p>Wir könnten hier fertig sein, aber eine wichtige Funktion fehlt noch: Volumes. Wenn unser CLI tool Dateien erstellt würden diese sonst im Docker container bleiben und der wird standardmäßig gelöscht da wir <code>--rm</code> verwenden.</p><p>Der <code>alias</code> wird also mit einem Volume angepasst.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>alias docker-rust-cli<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;docker run --rm -v $(pwd):/cmd-root-dir kevingimbel/rust-docker-cli-sample:1.0&#39;</span>
</code></pre></div><p>Mit <code>-v $(pwd):/cmd-root-dir</code> sagen wir Docker, dass das aktuelle Verzeichnis (<code>$(pwd)</code>) im Container als Pfad <code>/cmd-root-dir</code> gemounted werden soll. Jetzt müssen wir nur noch unserem Image sagen, dass es Dateien auch in diesem Verzeichnis ablegen soll. Das geht indem wir in der Dockerfile die <code>WORKDIR</code> setzen.</p><p>Das Dockerfile sieht nun wie folgt aus.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> clux/muslrust:1.45.0-stable as builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /volume</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cargo build --release<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /volume/target/x86_64-unknown-linux-musl/release/docker-cli-sample .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /cmd-root-dir</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p><code>WORKDIR</code> erstellt das Verzeichnis wenn es nicht existiert, wir müssen es also nicht selbst erstellen. Um diese Anpassung zu testen können wir unser Script eine Log Datei schreiben lassen. Dazu verändern wir den Rust Code wie folgt.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> std::env;
<span style=color:#66d9ef>use</span> std::fs;

<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
    <span style=color:#66d9ef>let</span> args: Vec<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> env::args().collect();
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{:?}&#34;</span>, args);
    fs::write(<span style=color:#e6db74>&#34;docker-cli-sample.log&#34;</span>, format<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;Args: {:?}&#34;</span>, args))<span style=color:#f92672>?</span>;
    Ok(())
}
</code></pre></div><p>Mit <code>fs::write</code> schreiben wir nun alle Argumente auch in die Datei <code>docker-cli-sample.log</code> statt sie nur im Terminal anzuzeigen. Jetzt muss das Verzeichnis nur noch wie oben geschrieben gemounted werden:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>alias docker-rust-cli<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;docker run --rm -v $(pwd):/cmd-root-dir kevingimbel/rust-docker-cli-sample:1.0&#39;</span>
</code></pre></div><p>Wichtig sind hierbei die einfachen Anführungszeichen (<code>'</code>) - ohne diese würde <code>$(pwd)</code> nur ein Mal ausgeführt werden statt bei jedem Aufruf!</p><p>Wenn wir jetzt den Befehl ausführen wird eine Log Datei in das aktuelle Verzeichnis geschrieben:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker-rust-cli
<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#e6db74>&#34;world&#34;</span><span style=color:#f92672>]</span>
$ cat docker-cli-sample.log
Args: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/docker-cli-sample&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#e6db74>&#34;world&#34;</span><span style=color:#f92672>]</span>
</code></pre></div><h2 id=fortgeschritten-versionierung>Fortgeschritten: Versionierung</h2><p>Für etwas mehr Komfort können wir eine Variable für den &ldquo;Docker Tag&rdquo;, also die Version unseres Images, nutzen. So kann man später einfach updaten ohne den eigentlichen Befehl anpassen zu müssen.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export MY_CLI_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span>
alias docker-rust-cli<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;docker run --rm -v $(pwd):/cmd-root-dir kevingimbel/rust-docker-cli-sample:$MY_CLI_VERSION&#39;</span>
</code></pre></div><p>Soll nun Version 1.1 verwendet werden muss lediglich die Variable <code>MY_CLI_VERSION</code> auf <code>1.1</code> geändert werden. Jeder mit Zugriff auf das Docker Image kann nun den Code in die <code>~/.bashrc</code> oder <code>~/.zshrc</code> kopieren und das CLI Programm nutzen.</p><h2 id=zusammenfassung>Zusammenfassung</h2><ul><li>Wir können mit <a href=https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds title="Docker Dokumentation über Multi-Stage Builds">Multi-Stage Builds</a> code in Docker kompilieren</li><li>Rust binaries können in kleinen Containern wie z.B. Alpine oder &ldquo;blanken&rdquo; Container ausgeführt werden</li><li>Mit einem <code>alias</code> können wir bequem und komfortable Docker Container ausführen als wären es &ldquo;installiere&rdquo; Binaries</li><li>Indem wir <code>WORKDIR</code> und Volumes nutzen können wir Dateien aus dem Container heraus speichern</li></ul><p>Der Quellcode für dieses Tutorial kann auf <a href=https://github.com/kevingimbel/docker-cli-sample>GitHub unter kevingimbel/docker-cli-sample</a> gefunden werde. Ein funktionierendes Docker Image gibt es auf <a href=https://hub.docker.com/r/kevingimbel/rust-docker-cli-sample>Docker Hub unter kevingimbel/rust-docker-cli-sample</a>.</p><p>Um das Docker Image zu nutzen kann folgender Befehl ausgeführt werden:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --rm kevingimbel/rust-docker-cli-sample:1.0 hello from docker
</code></pre></div></div></article></section><section class=tags-categories><section class=categories><h3>Kategorien</h3><ul class=tag-list><li class=tag-list__item><a class=tag-list__link title="View all posts categorized under code" href=https://kevingimbel.de/de/categories/code/>code</a></li></ul></section><section class=tags><h3>Tags</h3><ul class=tag-list><li class=tag-list__item><a class=tag-list__link title="View all posts tagged with rust" href=https://kevingimbel.de/de/tags/rust/>rust</a></li><li class=tag-list__item><a class=tag-list__link title="View all posts tagged with docker" href=https://kevingimbel.de/de/tags/docker/>docker</a></li><li class=tag-list__item><a class=tag-list__link title="View all posts tagged with cli" href=https://kevingimbel.de/de/tags/cli/>cli</a></li></ul></section></section><section class=support><h4>Dieser Inhalt hat dich weitergebracht?</h4><p>Wenn dieser Beitrag deiner Firma oder dir geholfen hat, freue ich mich wenn du eine Spende an eine der folgenden Organisationen machst</p><p></p><ul class=support-cause-list><li class=head><b>International</b></li><li><a href=https://donate.doctorswithoutborders.org/onetime.cfm>Doctors without borders</a></li><li><a href=https://www.amnesty.org/en/donate/>Amnasty International</a></li></ul><ul class=support-cause-list><li class=head><b>German</b></li><li><a href=https://www.uno-fluechtlingshilfe.de/unterstuetzen/spenden/jetzt-spenden/>UNO Flüchtlingshilfe</a></li><li><a href=https://www.amnesty.de/spenden>Amnesty</a></li><li><a href=https://www.greenpeace.de/spenden>Greenpeace</a></li></ul></section><section class=author><div class=left><img src=/images/general/mask-moshed_hud020fe899933685564972ef591654996_344172_200x200_resize_q75_box.jpg alt="Ein Bild von mir mit meiner DIY Maske. Das Bild ist stark bearbeitet und hat einen Regenbogeneffekt" class=avatar></div><div class=right><p>Kevin Gimbel</p><p>ist ein DevOps Engineer und begeisterter (Video)-Spieler. Er ist außerdem interessiert an Sci-Fi Themen,
Cyberpunk, dystopischen Büchern, und Technik.</p><p><em>Eine Maske zu tragen ist zur Zeit eine gute Idee!</em></p><p>Wer möchte kann gerne mehr <a href=/de/ueber-mich/>Über mich</a> erfahren.</p></div></section></main><footer class=footer><div class=left><p>&copy; 2009 - 2020 Kevin Gimbel. <a href=https://github.com/kevingimbel/kevingimbel.de/blob/master/LICENSE title="Lizenz auf Github.com ansehen">Lizenz</a>. <a href=/blog/2020/01/no-tracking/>No Tracking</a>.</p><p><small>Folge mir auf <a href=https://bullgit.party/@kevin title="Mein Mastodon Account auf bullgit.party" rel=me>Mastodon @kevin@bullgit.party</a></small></p><p><small>Mehr zu sagen? Schreibe mir via Matrix an <a href=https://matrix.to/#/@kevingimbel:bullgit.science title="Kontaktiere mich über Matrix">@kevingimbel:bullgit.science</a></a></small></p></div><div class=right><p><small class=xx-small>Fehler gefunden? Diese Seite <a href=https://github.com/kevingimbel/kevingimbel.de/tree/master/content/blog/2020-08-06-rust-cli-mit-docker-ausliefern.md>auf GitHub.com bearbeiten</a></a></small></p><p><small class=xx-small>In Europa 🇪🇺 mit Liebe, <a href=/thanks>Open Source Code</a> und <a href=https://gohugo.io/ title="Hugo static site generator" rel=nofollow>hugo</a> gemacht.<span class=fg-accent>&#9829;</span>.</small></p><p><small class=xx-small><a href=/legal>Impressum</a></small></p><p><small class=xx-small><code>¯\_(ツ)_/¯</code></small></p></div></footer></body></html>